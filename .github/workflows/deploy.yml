name: Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy_flyio:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        regions:
          - name: hk
            code: hkg
          - name: us
            code: sea
          - name: eu
            code: lhr
    steps:
      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Configure xray user
        run: jq ' .inbounds.[0].settings.clients.[0].id = "${{ secrets.XRAY_USER }}" ' ./config.json > ./xray.json
      - name: Create app
        env:
          FLY_ACCESS_TOKEN: ${{ secrets.FLY_ACCESS_TOKEN }}
        run: flyctl apps create bonjour-xray-${{ matrix.regions.name }} || true
      - name: Deploy app
        env:
          FLY_ACCESS_TOKEN: ${{ secrets.FLY_ACCESS_TOKEN }}
          FLY_APP: bonjour-xray-${{ matrix.regions.name }}
        run: flyctl deploy --app  --regions ${{ matrix.regions.code }}
      - name: Scale app count
        env:
          FLY_ACCESS_TOKEN: ${{ secrets.FLY_ACCESS_TOKEN }}
          FLY_APP: bonjour-xray-${{ matrix.regions.name }}
        run: flyctl scale count 1
