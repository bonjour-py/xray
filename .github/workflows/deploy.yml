name: Deploy

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  deploy_flyio:
    runs-on: ubuntu-latest
    steps:
      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Configure xray user bonjour
        run: jq '.inbounds.[0].settings.clients.[0].id = "${{ secrets.XRAY_USER }}"' ./config.json > ./tmp.json && mv tmp.json config.json
      - name: Create app
        env:
          FLY_ACCESS_TOKEN: ${{ secrets.FLY_ACCESS_TOKEN }}
        run: flyctl apps create bonjour-xray || true
      - name: Deploy app
        env:
          FLY_ACCESS_TOKEN: ${{ secrets.FLY_ACCESS_TOKEN }}
        run: flyctl deploy --regions sjc,lax,iad
      - name: Scale app count
        env:
          FLY_ACCESS_TOKEN: ${{ secrets.FLY_ACCESS_TOKEN }}
        run: |
          flyctl scale count 1 --region sjc --yes
          flyctl scale count 1 --region lax --yes
          flyctl scale count 1 --region iad --yes
